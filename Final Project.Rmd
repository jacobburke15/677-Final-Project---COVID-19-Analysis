---
title: "COVID-19 Analysis - Massachusetts Vs. New York State"
author: "Jacob Burke"
date: "02/05/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(earlyR)
library(EpiEstim)
library(incidence)

```

# Introduction 

For this project I decided to set my focus on the comparisons of COVID-19 infection rates and spread counts between county levels. More specifically I am comparing COVID counts and the infection rates of the two largest populated counties in Massachusetts, ie. Middlesex and Worcester. The data that I will be using can be found from the link https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/ .The data set found in this source encapsulates confirmed COVID-19 cases from multiple states in the US dating from Jan 22nd - May 1st. 


# Data Cleaning

Before we go any further, I need to subset the original data set to encapsulate just the confirmed COVID-19 counts for MA and NY specifically. The data also has to be gathered as the dates are currently in the column names. The code used to clean the data set prior to further analysis can be found within the corresponding .Rmd file for this report. 

```{r, echo = F}

data <- read.csv("covid_confirmed_usafacts.csv")

data <- filter(data, County.Name == "Middlesex County" | County.Name == "Worcester County")

data <- filter(data, State == "MA")

data <- gather(data, 
               key = "Date", 
               value = "Count", -c("ï..countyFIPS", "County.Name", 
                          "State", "stateFIPS"))

data$Date <- substring(data$Date, 2)

data <- data[, -c(1,3, 4)]

mid <- filter(data, County.Name == "Middlesex County")

worc <- filter(data, County.Name == "Worcester County")


change <- as.data.frame(diff(mid$Count, lag = 1, differences = 1))

change2 <- as.data.frame(diff(worc$Count, lag = 1, differences = 1))

add <- as.data.frame(0, nrow = 1, ncol = 1)

colnames(add) <- "diff"
colnames(change) <- "diff"
colnames(change2) <- "diff"

change <- rbind(add, change)
change2 <- rbind(add, change2)

mid <- cbind(mid, change)

worc <- cbind(worc, change2)

mid <- mid[, -3]
worc <- worc[, -3]

colnames(mid) <- c("Count.Name", "Date", "New Counts")
colnames(worc) <- c("Count.Name", "Date", "New Counts")

## selecting dates from Feb 20 - May 1

mid <- mid[31:101,]
worc <- worc[31:101,]

## getting dates into date formate 

mid$Date <- paste0(mid$Date, "20")

worc$Date <- paste0(worc$Date, "20")

worc$Date<- as.Date(worc$Date, "%m.%d.%Y")
mid$Date <- as.Date(mid$Date, "%m.%d.%Y")

## now we have the county counts, each day, for Worcester and Middlesex
```

# EDA

Now that our data is clean, we can begin to go forward with EDA. First comparing the timeline of confirmed counts in Middlesex County and worcester County from the middle of Febuary - May. 

```{r, echo = F}

ggplot(mid) +
 aes(x = Date, weight = `New Counts`) +
 geom_bar(fill = "#0c4c8a") + ggtitle("New COVID-19 Counts for Middlesex County (Feb 20 - May 1)") +
 theme_minimal() + theme(axis.text.x = element_text(angle = 90), axis.text=element_text(size=7))

ggplot(worc) +
 aes(x = Date, weight = `New Counts`) +
 geom_bar(fill = "#0c4c8a") + ggtitle("New COVID-19 Counts for Worcester County (Feb 20 - May 1)") +
 theme_minimal() + theme(axis.text.x = element_text(angle = 90), axis.text=element_text(size=7))



```

Now, using the "EpiEstem" package available within R, I'm going to look at the lambda value, which in epidemiology refers to the relative measure of the current “force of infection” or infectivity of an outbreak. Overall, you want to see lambda falling, NOT rising. I'll compare the changing lambda value over the last few months for both Middlesex and Worcester. 

The parameters needed to calculate this lambda value are the incident counts, and the distribution of serial intervals (SI). This SI is a distribution of the time between the date of the first onset of symptoms for one case (in this case COVID-19) and the dates of onsets for any secondary cases that were because of spread from the first. From research online, I found that in many epidemiological studies they set the SI distribution as a discrete gamma distribution. I've set the SI for this investigation as a discrete gamma distribution, with a mean of 5 days and standard deviation of 3.4 days. 

```{r, echo = F}


## discrete gamma distribution with a mean of 5.0 days and a standard deviation of 3.4 for the serial interval distribution.


alpha <- 2
beta <- 2.5

SI = dgamma(1:71, alpha, rate = 1/beta)

SI[1] <- 0.0

## getting lambda (serial interval) for middlesex 
lambda <- overall_infectivity(mid$`New Counts`, SI)

lambda <- as.data.frame(lambda)

lambda[1,] <- 0

## getting lambda (serial interval) for worcester

lambda1 <- overall_infectivity(worc$`New Counts`, SI)

lambda1 <- as.data.frame(lambda1)

lambda1[1,] <- 0

mid <- cbind(mid, lambda)
worc <- cbind(worc, lambda1)


ggplot(mid)+
  geom_bar(aes(x = Date, weight = `New Counts`), fill = "blue") +
  geom_line(aes(x = Date, y = lambda), size = 1.5, colour = "yellow") + labs(y = "New counts") +
 theme_minimal()+ ggtitle("COVID-19 Cases and Lambda Infectivity for Middlesex County (Feb 20 - May 1)"
                          ,   subtitle = "Lamda shown as the Yellow Line")

ggplot(worc)+
  geom_bar(aes(x = Date, weight = `New Counts`), fill = "blue") +
  geom_line(aes(x = Date, y = lambda1), size = 1.5, colour = "yellow") + labs(y = "New counts")+
 theme_minimal()+ ggtitle("COVID-19 Cases and Lambda Infectivity for Worcester County (Feb 20 - May 1)",   subtitle = "Lamda shown as the Yellow Line")


```

From here, we can see that both counties are currently not controlling the infectivity of COVID-19 too well, as the lambda value continues to stay fairly high (as of May 1st). However, Middlesex has had a drop in infectivity in the last week or so, which is actually better than Worcester's case currently as their infectivity is continuing to consistently rise. However, of course this change in infectivity is all relative as Middlesex consistently has a higher number of COVID-19 cases compared to Worcester. This could be an insight into how well Middlesex is social distancing compared to Worcester. 




```{r}

us_incidence_fit <- incidence::fit(mid$`New Counts`, split = NULL)

?incidence::fit()

?incidence()

```




